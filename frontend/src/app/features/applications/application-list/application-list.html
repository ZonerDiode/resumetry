<div class="applications-container">
  <div class="filter-bar">
    <div>
      <h1>Job Applications</h1>
      <p class="subtitle">Showing {{ displayedApplications().length }} most recent applications</p>
    </div>

    <div class="filter-actions">
      <div class="view-toggle">
        <button
          type="button"
          class="toggle-btn"
          [class.active]="viewMode() === 'table'"
          (click)="viewMode.set('table')"
          title="Table view"
        >
          <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
            <rect x="1" y="1" width="16" height="3" rx="0.5"/>
            <rect x="1" y="5.5" width="16" height="3" rx="0.5"/>
            <rect x="1" y="10" width="16" height="3" rx="0.5"/>
            <rect x="1" y="14.5" width="16" height="3" rx="0.5"/>
          </svg>
        </button>
        <button
          type="button"
          class="toggle-btn"
          [class.active]="viewMode() === 'card'"
          (click)="viewMode.set('card')"
          title="Card view"
        >
          <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
            <rect x="1" y="1" width="7" height="7" rx="1"/>
            <rect x="10" y="1" width="7" height="7" rx="1"/>
            <rect x="1" y="10" width="7" height="7" rx="1"/>
            <rect x="10" y="10" width="7" height="7" rx="1"/>
          </svg>
        </button>
        <button
          type="button"
          class="toggle-btn"
          [class.active]="viewMode() === 'recruiter'"
          (click)="viewMode.set('recruiter')"
          title="Recruiter view"
        >
          <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
            <circle cx="9" cy="6" r="3.5"/>
            <path d="M2.5 16.5c0-3.6 2.9-6.5 6.5-6.5s6.5 2.9 6.5 6.5"/>
          </svg>
        </button>
      </div>
      <input
        type="text"
        class="filter-input"
        placeholder="Filter by company..."
        (input)="onFilterChange($event)"
        [value]="filterText()"
      />
      <button type="button" class="btn btn-primary" (click)="onCreateNew()">+ New Application</button>
      <button type="button" class="btn btn-secondary" (click)="onViewReports()">Reports</button>
    </div>
  </div>

  @if (isLoading()) {
    <div class="loading">Loading applications...</div>
  }

  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  @if (!isLoading() && !error()) {
    @if (displayedApplications().length === 0) {
      <div class="empty-state">
        <p>No applications found.</p>
        <button type="button" class="btn btn-primary" (click)="onCreateNew()">Create Your First Application</button>
      </div>
    } @else {
      @if (viewMode() === 'table') {
        <table class="applications-table">
          <thead>
            <tr>
              <th>Top</th>
              <th>Company</th>
              <th>Role</th>
              <th>Salary</th>
              <th>Applied</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @for (app of displayedApplications(); track app.id) {
              <tr class="table-row" (click)="onSelectApplication(app)" (keydown.enter)="onSelectApplication(app)" tabindex="0" role="button">
                <td>@if (app.topJob) {<span class="top-job-star">&#9733;</span>}</td>
                <td class="col-company">{{ app.company }}</td>
                <td>{{ app.role }}</td>
                <td class="col-salary">{{ app.salary || '—' }}</td>
                <td>{{ formatDate(app.appliedDate) }}</td>
                <td>
                  @if (getLatestStatus(app); as latest) {
                    <span class="status-badge" [style.background-color]="getStatusColor(latest.status)">
                      {{ latest.status }}
                    </span>
                  } @else {
                    <span class="status-badge status-badge-na">N/A</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else if (viewMode() === 'recruiter') {
        @if (recruiterApplications().length === 0) {
          <div class="empty-state">
            <p>No applications with a recruiter.</p>
          </div>
        } @else {
          <table class="applications-table recruiter-table">
            <thead class="visually-hidden">
              <tr>
                <th>Top</th>
                <th>Company</th>
                <th>Role</th>
                <th>Salary</th>
                <th>Applied</th>
                <th>Status</th>
              </tr>
            </thead>
            @for (app of recruiterApplications(); track app.id) {
              <tbody class="recruiter-group" (click)="onSelectApplication(app)" (keydown.enter)="onSelectApplication(app)" tabindex="0" role="button">
                <tr class="recruiter-row">
                  <td colspan="6">
                    <span class="recruiter-name">{{ app.recruiterName }}</span>
                    @if (app.recruiterCompany) {
                      <span class="recruiter-company">{{ app.recruiterCompany }}</span>
                    }
                  </td>
                </tr>
                <tr class="data-row">
                  <td class="top-job-star">@if (app.topJob) {&#9733;}</td>
                  <td class="col-company">{{ app.company }}</td>
                  <td>{{ app.role }}</td>
                  <td class="col-salary">{{ app.salary || '—' }}</td>
                  <td>{{ formatDate(app.appliedDate) }}</td>
                  <td>
                    @if (getLatestStatus(app); as latest) {
                      <span class="status-badge" [style.background-color]="getStatusColor(latest.status)">
                        {{ latest.status }}
                      </span>
                    } @else {
                      <span class="status-badge status-badge-na">N/A</span>
                    }
                  </td>
                </tr>
                @if (app.notes.length > 0) {
                  <tr class="notes-row">
                    <td colspan="6">
                      <div class="recruiter-notes">
                        @for (note of sortedNotes(app.notes); track $index) {
                          <div class="recruiter-note">
                            <span class="note-date">{{ formatDate(note.occurDate) }}</span>
                            <span class="note-text">{{ note.description }}</span>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            }
          </table>
        }
      } @else {
        <div class="applications-grid">
          @for (app of displayedApplications(); track app.id) {
            <div class="application-card" (click)="onSelectApplication(app)" (keydown.enter)="onSelectApplication(app)" tabindex="0" role="button">
              <div class="card-header">
                <h2 class="company-name">{{ app.company }}</h2>
                @if (app.topJob) {
                  <span class="top-job-star-card">&#9733;</span>
                }
              </div>

              <div class="card-body">
                <p class="role">{{ app.role }}</p>
                <p class="salary">{{ app.salary || 'Salary not specified' }}</p>
                <p class="date">Applied: {{ formatDate(app.appliedDate) }}</p>
                @if (app.recruiterName) {
                  <p class="recruiter">Recruiter: {{ app.recruiterName }}</p>
                }
                @if (app.recruiterCompany) {
                  <p class="recruiter">Recruiter Company: {{ app.recruiterCompany }}</p>
                }
              </div>

              <div class="card-footer">
                @if (getLatestStatus(app); as latest) {
                  <span
                    class="status-badge"
                    [style.background-color]="getStatusColor(latest.status)"
                  >
                    {{ latest.status }}
                  </span>
                } @else {
                  <span class="status-badge status-badge-na">No Status</span>
                }
                @if (app.notes.length > 0) {
                  <span class="notes-count">{{ app.notes.length }} note(s)</span>
                }
              </div>
            </div>
          }
        </div>
      }
    }
  }
</div>
